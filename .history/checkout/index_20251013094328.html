<!doctype html>
<html lang="pt-BR">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <title>Checkout</title>
Â  <style>
Â  Â  :root{--bg:#0b0c10;--card:#16181d;--muted:#8b93a1;--txt:#e9edf1;--acc:#22c55e;--bd:#232730;}
Â  Â  *{box-sizing:border-box}
Â  Â  body{margin:0;font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--txt)}
Â  Â  .wrap{max-width:980px;margin:32px auto;padding:0 16px}
Â  Â  .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px;}
Â  Â  .tabs{display:flex;gap:8px;flex-wrap:wrap}
Â  Â  .tab{border:1px solid var(--bd);background:#0f1115;color:var(--txt);padding:8px 12px;border-radius:10px;cursor:pointer}
Â  Â  .tab.active{background:var(--acc);color:#092b14;font-weight:700;border-color:#15803d}
Â  Â  .grid{display:grid;grid-template-columns:2fr 1fr;gap:16px}
Â  Â  .card{background:var(--card);border:1px solid var(--bd);border-radius:12px;padding:16px}
Â  Â  /* AJUSTE RESPONSIVO: Imagem com proporÃ§Ã£o automÃ¡tica */
Â  Â  .img{width:100%;height:auto;aspect-ratio:16/9;border-radius:12px;object-fit:cover;border:1px solid var(--bd);background:#0f1115}
Â  Â  h1{font-size:22px;margin:0}
Â  Â  h2{font-size:16px;margin:0 0 10px}
Â  Â  .muted{color:var(--muted);font-size:12px}
Â  Â  .price{font-size:22px;font-weight:800}
Â  Â  .row{display:flex;justify-content:space-between;align-items:center;margin:8px 0}
Â  Â  .total{font-size:18px;font-weight:800}
Â  Â  .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;cursor:pointer;font-weight:700;width:100%}
Â  Â  .btn-buy{background:var(--acc);color:#062a12}
Â  Â  .badge{display:inline-flex;gap:6px;align-items:center;background:#0f1115;border:1px solid var(--bd);padding:6px 10px;border-radius:999px;color:#d1d7e0}
Â  Â  .list{margin:10px 0 0;padding:0 0 0 18px;color:#cfd5de}

Â  Â  /* order bumps */
Â  Â  .bump{display:flex;gap:10px;align-items:flex-start;border:1px dashed #2b313b;padding:10px;border-radius:10px;margin-bottom:10px;background:#0f1115}
Â  Â  .bump input{margin-top:2px}
Â  Â  .bump-img{width:56px;height:56px;border-radius:10px;object-fit:cover;border:1px solid var(--bd);background:#0f1115; flex-shrink: 0;}
Â  Â  .bump-body{display:flex;flex-direction:column;gap:2px}

Â  Â  /* botÃ£o voltar */
Â  Â  .backdash {
Â  Â  Â  position: fixed; top: 14px; right: 14px; z-index: 9999;
Â  Â  Â  background: #22c55e; color: #062a12; font: 600 14px/1.1 system-ui,-apple-system,Segoe UI,Roboto,Arial;
Â  Â  Â  padding: 10px 14px; border-radius: 10px; text-decoration: none; box-shadow: 0 6px 18px rgba(0,0,0,.35);
Â  Â  Â  border: 0; transition: transform .06s ease, filter .2s ease; display: inline-flex; align-items: center; gap: 8px;
Â  Â  }
Â  Â  .backdash:hover { transform: translateY(-1px); filter: brightness(1.05); }
Â  Â  .backdash:active { transform: translateY(0); }
Â  Â  .backdash svg { width: 16px; height: 16px; } Â  Â 

Â  Â  /* === Cards de forma de pagamento === */
Â  Â  .paygrid{
Â  Â  Â  display:grid;
Â  Â  Â  grid-template-columns: repeat(3, minmax(0, 1fr));
Â  Â  Â  gap:12px; margin-top: 12px;
Â  Â  }
Â  Â  .paycard{
Â  Â  Â  position:relative; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px;
Â  Â  Â  padding:16px 12px; background:#0f1115; border:1.5px solid #2f3540; border-radius:12px;
Â  Â  Â  cursor:pointer; transition:.18s border-color,.18s box-shadow,.18s background; min-height:92px;
Â  Â  }
Â  Â  .paycard:hover{ border-color:#3b4350; }
Â  Â  .paycard input{ position:absolute; inset:0; opacity:0; cursor:pointer; }
Â  Â  .paycard .ico{
Â  Â  Â  display:inline-flex; align-items:center; justify-content:center;
Â  Â  Â  width:34px; height:34px; border-radius:8px; background:#0b0e13;
Â  Â  }
Â  Â  .paycard .ico svg{ width:24px; height:24px; display:block }
Â  Â  .paycard .label{ font-weight:700; font-size:13px; color:#e9edf1 }
Â  Â  .paycard:has(input:checked){
Â  Â  Â  border-color:#22c55e; box-shadow:0 0 0 3px rgba(34,197,94,.15) inset; background:#0b1110;
Â  Â  }
Â  Â  .paycard.card .ico{ background:rgba(96,165,250,.15) }
Â  Â  .paycard.boleto .ico{ background:rgba(234,179,8,.15) }
Â  Â  .paycard.pix .ico{ background:rgba(34,197,94,.15); }
Â  Â  .pix-icon{ width:24px; height:24px; display:block; }

Â  Â  /* bloco de dicas */
Â  Â  .paytips{
Â  Â  Â  margin-top:10px; border:1px dashed #2f3540; border-radius:10px; padding:10px 12px; background:#0c0f14;
Â  Â  }
Â  Â  .paytips .ok{ display:flex; gap:8px; align-items:center; color:#cfe7d7; font-size:13px }
Â  Â  .paytips .ok:before{
Â  Â  Â  content:''; width:10px; height:10px; border-radius:999px; background:#22c55e;
Â  Â  Â  box-shadow:0 0 0 3px rgba(34,197,94,.18);
Â  Â  }

Â  Â  /* ======== PIX RESPONSIVO ======== */
Â  Â  .qr-wrap{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap}
Â  Â  .qr{width:clamp(180px, 45vw, 360px)}
Â  Â  .qr img{width:100%;height:auto;display:block;border:1px solid #2b313b;border-radius:12px;background:#0b0c10}
Â  Â  .pix-side{min-width:220px;max-width:520px;flex:1}
Â  Â  pre.codebox{
Â  Â  Â  max-width:100%;overflow:auto;white-space:pre-wrap;word-break:break-word;
Â  Â  Â  background:#0b0c10;border:1px dashed #2f3540;padding:10px;border-radius:10px;
Â  Â  Â  color:#e9edf1;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:13px;line-height:1.35
Â  Â  }

Â  Â  /* Form blocks */
Â  Â  .hidden{display:none}
Â  Â  .field{margin:8px 0; display:flex; flex-direction:column; gap:6px}
Â  Â  .field label{font-size:12px; color:#cfd5de}
Â  Â  .field input, .field select{
Â  Â  Â  background:#0c0f14; border:1px solid #2f3540; color:#e9edf1; border-radius:10px; padding:10px 12px; outline:none;
Â  Â  }
Â  Â  .status{margin-top:8px; font-size:13px}

Â  Â  

Â  Â  /* ========== MEDIA QUERIES PARA RESPONSIVIDADE ========== */
Â  Â  @media (max-width:880px){
Â  Â  Â  Â  .grid{grid-template-columns:1fr}
Â  Â  Â  Â  .wrap{margin: 16px auto;}
Â  Â  }
Â  Â  @media (max-width: 720px){
Â  Â  Â  Â  .paygrid{ grid-template-columns: repeat(2, 1fr); }
Â  Â  }
Â  Â  @media (max-width: 480px){
Â  Â  Â  Â  .paygrid{ grid-template-columns: 1fr; }
Â  Â  }
Â  Â  @media (max-width:520px){
Â  Â  Â  .pix-side{min-width:100%}
Â  Â  }
Â  </style>
Â  <script src="https://sdk.mercadopago.com/js/v2"></script>

</head>
<body>

Â  <a href="/admin/dashboard.html" class="backdash" title="Voltar ao Dashboard">
Â  Â  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
Â  Â  Â  Â  Â stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
Â  Â  Â  <path d="M15 18l-6-6 6-6"/>
Â  Â  </svg>
Â  Â  Dashboard
Â  </a>

Â  <div class="wrap">
Â  Â  <div class="head">
Â  Â  Â  <h1>Checkout</h1>
Â  Â  Â  <span class="badge" id="supportBadge">Suporte</span>
Â  Â  </div>

Â  Â  <div class="tabs" id="tabs"></div>

Â  Â  <div class="grid">
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <img id="cover" class="img" alt="Capa do produto" />
Â  Â  Â  Â  <h2 id="title" style="margin-top:12px"></h2>
Â  Â  Â  Â  <div class="muted">Resumo da oferta</div>
Â  Â  Â  Â  <ul class="list" id="summaryList">
Â  Â  Â  Â  Â  <li>Entrega imediata apÃ³s pagamento</li>
Â  Â  Â  Â  Â  <li>Acesso vitalÃ­cio</li>
Â  Â  Â  Â  Â  <li>AtualizaÃ§Ãµes quando disponÃ­veis</li>
Â  Â  Â  Â  </ul>
Â  Â  Â  Â  <div style="height:12px"></div>
Â  Â  Â  Â  <h2>Adicionais (Order Bumps)</h2>
Â  Â  Â  Â  <div id="bumps"></div>
Â  Â  Â  Â  </div>

Â  Â  Â  <div class="card">
Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <div class="muted">PreÃ§o base</div>
Â  Â  Â  Â  Â  <div id="basePrice" class="price">R$ 0,00</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="bumpLines"></div>
Â  Â  Â  Â  <div class="row" style="border-top:1px solid var(--bd);padding-top:10px;margin-top:12px">
Â  Â  Â  Â  Â  <div class="total">Total</div>
Â  Â  Â  Â  Â  <div id="total" class="total">R$ 0,00</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="height:12px"></div>
Â  Â  Â  Â  <button class="btn btn-buy" id="buyBtn">Comprar</button>
Â  Â  Â  Â  <div class="muted" style="margin-top:8px">Pagamento seguro.</div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <script>
  // Defina sua chave pÃºblica aqui para que o script a encontre
  window.MP_PUBLIC_KEY = 'APP_USR-d773af7e-3337-4a03-8e51-9a303624a029'; // sua PUBLIC KEY (nÃ£o o access token)

Â  // ---------- UtilitÃ¡rios de imagem ----------
Â  function resolveUrl(u){
Â  Â  try { return u ? new URL(u, location.origin).href : ''; }
Â  Â  catch { return ''; }
Â  }
Â  function setImgWithFallback(img, primaryUrl, fallbackUrl, hardPlaceholder){
Â  Â  const target = resolveUrl(primaryUrl) || fallbackUrl || hardPlaceholder || '';
Â  Â  const current = img.getAttribute('src') || '';
Â  Â  if (current === target) return;
Â  Â  img.src = target;
Â  Â  const handler = () => {
Â  Â  Â  img.removeEventListener('error', handler);
Â  Â  Â  if (target !== fallbackUrl && fallbackUrl) {
Â  Â  Â  Â  img.src = fallbackUrl;
Â  Â  Â  Â  img.onerror = () => { img.onerror = null; img.src = hardPlaceholder || fallbackUrl; };
Â  Â  Â  } else {
Â  Â  Â  Â  img.src = hardPlaceholder || fallbackUrl;
Â  Â  Â  }
Â  Â  };
Â  Â  img.addEventListener('error', handler, { once: true });
Â  }

Â  // ---------- Helpers ----------
Â  const parseBRL = (s='')=>{
Â  Â  s = (s+'').replace(/\s/g,'').replace(/[R$\s]/gi,'').replace(/\./g,'').replace(',', '.');
Â  Â  const n = Number(s); return isFinite(n) ? n : 0;
Â  };
Â  const fmtBRL = (n)=> n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
Â  const makeOrderId = ()=> 'ORD-' + Date.now().toString(36).toUpperCase().slice(-6);
Â  const el= (id)=>document.getElementById(id);

Â  // ---------- Estado ----------
Â  let CONFIG=null, cur='A', CURRENT_ORDER_ID=null;

Â  async function loadConfig(){
Â  Â  const q = new URLSearchParams(location.search);
Â  Â  const p = (q.get('product') || 'A').toUpperCase();
Â  Â  cur = (p === 'B') ? 'B' : 'A';

Â  Â  const r = await fetch('/config',{cache:'no-store'});
Â  Â  CONFIG = await r.json();

Â  Â  const tabs = el('tabs');
Â  Â  const aLabel = CONFIG?.produtoA?.rotulo || 'Produto A';
Â  Â  const bLabel = CONFIG?.produtoB?.rotulo || 'Produto B';
Â  Â  tabs.innerHTML = `
Â  Â  Â  <button class="tab" data-k="A">${aLabel}</button>
Â  Â  Â  <button class="tab" data-k="B">${bLabel}</button>
Â  Â  `;
Â  Â  [...tabs.children].forEach(x => x.classList.toggle('active', x.dataset.k === cur));
Â  Â  tabs.onclick = (ev)=>{
Â  Â  Â  const b = ev.target.closest('.tab'); if(!b) return;
Â  Â  Â  cur = b.dataset.k;
Â  Â  Â  [...tabs.children].forEach(x=>x.classList.remove('active'));
Â  Â  Â  b.classList.add('active');
Â  Â  Â  renderProduct();
Â  Â  };

Â  Â  el('supportBadge').textContent = (CONFIG.whatsapp_suporte || 'Suporte');
Â  Â  renderProduct();
Â  }

Â  function getProd(){ return cur==='A' ? (CONFIG?.produtoA || {}) : (CONFIG?.produtoB || {}) }

Â  function renderProduct(){
Â  Â  const p = getProd();

Â  Â  const cover = el('cover');
Â  Â  cover.setAttribute('width','800'); cover.setAttribute('height','450'); // 16:9
Â  Â  setImgWithFallback(
Â  Â  Â  cover,
Â  Â  Â  (p.cover_url || '').trim(),
Â  Â  Â  '/assets/placeholder-cover.jpg',
Â  Â  Â  '/assets/placeholder-cover.jpg'
Â  Â  );

Â  Â  el('title').textContent = p.titulo || `Produto ${cur}`;
Â  Â  el('basePrice').textContent = p.preco || 'R$ 0,00';

Â  Â  const host = el('bumps'); host.innerHTML = '';
Â  Â  el('bumpLines').innerHTML = '';

Â  Â  const bumps = Array.isArray(p.bumps) ? p.bumps.slice(0,3) : [];
Â  Â  bumps.forEach(b=>{
Â  Â  Â  const id = `bump_${b.id || Math.random().toString(36).slice(2)}`;
Â  Â  Â  const row = document.createElement('label');
Â  Â  Â  row.className = 'bump';
Â  Â  Â  row.innerHTML = `
Â  Â  Â  Â  <input type="checkbox" id="${id}" data-id="${b.id || id}" data-preco="${b.preco||''}">
Â  Â  Â  Â  <img class="bump-img" alt="">
Â  Â  Â  Â  <div class="bump-body">
Â  Â  Â  Â  Â  <div><strong>${b.titulo || 'Adicional'}</strong></div>
Â  Â  Â  Â  Â  <div class="muted">${b.preco || ''}</div>
Â  Â  Â  Â  </div>
Â  Â  Â  `;
Â  Â  Â  host.appendChild(row);

Â  Â  Â  const img = row.querySelector('.bump-img');
Â  Â  Â  img.setAttribute('width','56'); img.setAttribute('height','56');
Â  Â  Â  setImgWithFallback(
Â  Â  Â  Â  img,
Â  Â  Â  Â  (b.img_url || '').trim(),
Â  Â  Â  Â  '/assets/placeholder-bump.jpg',
Â  Â  Â  Â  '/assets/placeholder-bump.jpg'
Â  Â  Â  );
Â  Â  });

Â  Â  calcTotal();
Â  Â  host.onchange = ()=>{ calcTotal(); updatePayPanelTotal(); };

Â  Â  const btn = el('buyBtn'); if (btn) btn.onclick = onBuy;

Â  Â  ensurePayPanel();
Â  }

Â  function computeTotal(){
Â  Â  const p = getProd(); let total = parseBRL(p.preco || '0');
Â  Â  const bumps = Array.from(el('bumps').querySelectorAll('input[type=checkbox]'));
Â  Â  bumps.forEach(chk=>{ if(chk.checked){ total += parseBRL(chk.dataset.preco||'0'); } });
Â  Â  return total;
Â  }
Â  function calcTotal(){ el('total').textContent = fmtBRL(computeTotal()); }

Â  // ---------- Painel pagamento ----------
Â  let mp = null, cardForm = null;

Â  function ensurePayPanel(){
Â  Â  if (document.getElementById('payPanel')) return;

Â  Â  const panel = document.createElement('div');
Â  Â  panel.id = 'payPanel';
Â  Â  panel.style.marginTop = '16px';
Â  Â  panel.style.padding = '12px';
Â  Â  panel.style.border = '1px solid var(--bd, #232730)';
Â  Â  panel.style.borderRadius = '12px';
Â  Â  panel.style.background = '#0f1115';
Â  Â  panel.style.display = 'none';

Â  Â  panel.innerHTML = `
Â  Â  Â  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
Â  Â  Â  Â  <strong>Escolha como deseja pagar</strong>
Â  Â  Â  Â  <div class="muted">Total: <span id="payPanelTotal">â€“</span></div>
Â  Â  Â  </div>

Â  Â  Â  <div class="paygrid" role="radiogroup" aria-label="Forma de pagamento">
Â  Â  Â  Â  <label class="paycard pix">
Â  Â  Â  Â  Â  <input type="radio" name="paymethod" value="pix" checked>
Â  Â  Â  Â  Â  <span class="ico" aria-hidden="true">
Â  Â  Â  Â  Â  Â  <img class="pix-icon"
Â  Â  Â  Â  Â  Â  Â  Â  Â src="https://img.icons8.com/?size=100&id=Dk4sj0EM4b20&format=png&color=000000"
Â  Â  Â  Â  Â  Â  Â  Â  Â alt="Pix" onerror="this.src='/assets/pix.png'">
Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  <span class="label">PIX</span>
Â  Â  Â  Â  </label>

Â  Â  Â  Â  <label class="paycard card">
Â  Â  Â  Â  Â  <input type="radio" name="paymethod" value="card">
Â  Â  Â  Â  Â  <span class="ico" aria-hidden="true">
Â  Â  Â  Â  Â  Â  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
Â  Â  Â  Â  Â  Â  Â  <rect x="2" y="5" width="20" height="14" rx="2" />
Â  Â  Â  Â  Â  Â  Â  <line x1="2" y1="10" x2="22" y2="10" />
Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  <span class="label">CartÃ£o</span>
Â  Â  Â  Â  </label>

Â  Â  Â  Â  <label class="paycard boleto">
Â  Â  Â  Â  Â  <input type="radio" name="paymethod" value="boleto">
Â  Â  Â  Â  Â  <span class="ico" aria-hidden="true">
Â  Â  Â  Â  Â  Â  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
Â  Â  Â  Â  Â  Â  Â  <path d="M3 7v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7M6 10v4m3-4v4m3-4v4m3-4v4" />
Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  <span class="label">Boleto</span>
Â  Â  Â  Â  </label>
Â  Â  Â  </div>

Â  Â  Â  <div class="paytips" id="payTips"></div>

Â  Â  Â  Â  Â  Â  <section id="card-block" class="hidden">
Â  Â  Â  Â  <h3 style="margin:10px 0">Pagamento com CartÃ£o</h3>
Â  Â  Â  Â  <form id="card-form">
Â  Â  Â  Â  Â  <div id="form-card-number" class="field"></div>
Â  Â  Â  Â  Â  <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
Â  Â  Â  Â  Â  Â  <div id="form-card-expiration-date" class="field"></div>
Â  Â  Â  Â  Â  Â  <div id="form-security-code" class="field"></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div id="form-cardholder-name" class="field"></div>
Â  Â  Â  Â  Â  <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
Â  Â  Â  Â  Â  Â  <div id="form-issuer" class="field"></div>
Â  Â  Â  Â  Â  Â  <div id="form-installments" class="field"></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="field">
Â  Â  Â  Â  Â  Â  <label for="form-doc-number">CPF do titular</label>
Â  Â  Â  Â  Â  Â  <input id="form-doc-number" type="text" inputmode="numeric" placeholder="000.000.000-00" required>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="field">
Â  Â  Â  Â  Â  Â  <label for="form-payer-email">Email do comprador</label>
Â  Â  Â  Â  Â  Â  <input id="form-payer-email" type="email" placeholder="seu@email.com" required>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </form>
Â  Â  Â  Â  <div id="card-result" class="status"></div>
Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  <section id="boleto-block" class="hidden">
Â  Â  Â  Â  <h3 style="margin:10px 0">Gerar Boleto</h3>
Â  Â  Â  Â  <form id="boleto-form">
Â  Â  Â  Â  Â  <div class="field">
Â  Â  Â  Â  Â  Â  <label for="boleto-name">Nome completo</label>
Â  Â  Â  Â  Â  Â  <input id="boleto-name" type="text" required>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="field">
Â  Â  Â  Â  Â  Â  <label for="boleto-cpf">CPF</label>
Â  Â  Â  Â  Â  Â  <input id="boleto-cpf" type="text" inputmode="numeric" required>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="field">
Â  Â  Â  Â  Â  Â  <label for="boleto-email">Email</label>
Â  Â  Â  Â  Â  Â  <input id="boleto-email" type="email" required>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </form>
Â  Â  Â  Â  <div id="boleto-result" class="status"></div>
Â  Â  Â  </section>

Â  Â  Â  <div id="payResult" class="muted" style="margin:8px 0 12px 0;"></div>

Â  Â  Â  <div style="display:flex;gap:8px;flex-wrap:wrap">
Â  Â  Â  Â  <button id="btnPayNow" style="padding:10px 14px;border:0;border-radius:10px;background:#22c55e;color:#062a12;cursor:pointer;font-weight:600;">Finalizar Pagamento</button>
Â  Â  Â  Â  <button id="btnPayClose" style="padding:10px 14px;border:1px solid #333;border-radius:10px;background:#101217;color:#e9edf1;cursor:pointer;font-weight:600;">Cancelar</button>
Â  Â  Â  Â  <button id="btnGoMP" title="Abrir no Mercado Pago (fallback)" style="padding:10px 14px;border:1px solid #333;border-radius:10px;background:#101217;color:#e9edf1;cursor:pointer;font-weight:600;">Pagar no Mercado Pago</button>
Â  Â  Â  </div>
Â  Â  `;

Â  Â  const anchor = document.getElementById('bumps');
Â  Â  anchor.parentElement.appendChild(panel);

Â  Â  // BotÃµes
Â  Â  panel.querySelector('#btnPayNow').onclick = doProcessPayment;
Â  Â  panel.querySelector('#btnPayClose').onclick = () => togglePayPanel(false);
Â  Â  panel.querySelector('#btnGoMP').onclick = () => {
Â  Â  Â  const url = buildRedirectUrl(CURRENT_ORDER_ID || makeOrderId());
Â  Â  Â  window.location.href = url;
Â  Â  };

Â  Â  // Radio -> alterna blocos
Â  Â  panel.querySelectorAll('input[name="paymethod"]').forEach(r=>{
Â  Â  Â  r.addEventListener('change', ()=>{
Â  Â  Â  Â  showBlock(r.value);
Â  Â  Â  Â  setTips(r.value);
Â  Â  Â  });
Â  Â  });

Â  Â  // dicas iniciais
Â  Â  const tips = document.getElementById('payTips');
Â  Â  function setTips(m){
Â  Â  Â  if (!tips) return;
Â  Â  Â  if (m === 'pix'){
Â  Â  Â  Â  tips.innerHTML = `
Â  Â  Â  Â  Â  <div class="ok">LiberaÃ§Ã£o imediata</div>
Â  Â  Â  Â  Â  <div class="ok">Pague usando o app do seu banco</div>`;
Â  Â  Â  } else if (m === 'card'){
Â  Â  Â  Â  tips.innerHTML = `
Â  Â  Â  Â  Â  <div class="ok">AprovaÃ§Ã£o rÃ¡pida</div>
Â  Â  Â  Â  Â  <div class="ok">Tudo acontece nesta pÃ¡gina</div>`;
Â  Â  Â  } else {
Â  Â  Â  Â  tips.innerHTML = `
Â  Â  Â  Â  Â  <div class="ok">Gere e pague no banco ou lotÃ©rica</div>
Â  Â  Â  Â  Â  <div class="ok">ConfirmaÃ§Ã£o em atÃ© 3 dias Ãºteis</div>`;
Â  Â  Â  }
Â  Â  }
Â  Â  setTips('pix');

Â  Â  function showBlock(kind) {
Â  Â  Â  document.querySelector('#card-block').classList.toggle('hidden', kind !== 'card');
Â  Â  Â  document.querySelector('#boleto-block').classList.toggle('hidden', kind !== 'boleto');
Â  Â  }

Â  Â  // Mercado Pago inicializaÃ§Ã£o (somente 1x)
Â  Â  try{
Â  Â  Â  const pub = (window.MP_PUBLIC_KEY || '').trim();
Â  Â  Â  if (!pub) console.warn('MP_PUBLIC_KEY nÃ£o definida no front. Injete window.MP_PUBLIC_KEY.');
Â  Â  Â  mp = new MercadoPago(pub || 'test_public_key', { locale: 'pt-BR' });

Â  Â  Â  // CardForm (tokenizaÃ§Ã£o segura)
Â  Â  Â  cardForm = mp.cardForm({
Â  Â  Â  Â  amount: '0', // atualizado dinamicamente antes de pagar
Â  Â  Â  Â  iframe: true,
Â  Â  Â  Â  form: {
Â  Â  Â  Â  Â  id: 'card-form',
Â  Â  Â  Â  Â  cardNumber: { id: 'form-card-number', placeholder: 'NÃºmero do cartÃ£o' },
Â  Â  Â  Â  Â  expirationDate: { id: 'form-card-expiration-date', placeholder: 'MM/AA' },
Â  Â  Â  Â  Â  securityCode: { id: 'form-security-code', placeholder: 'CVV' },
Â  Â  Â  Â  Â  cardholderName: { id: 'form-cardholder-name', placeholder: 'Nome impresso no cartÃ£o' },
Â  Â  Â  Â  Â  issuer: { id: 'form-issuer', placeholder: 'Banco emissor' },
Â  Â  Â  Â  Â  installments: { id: 'form-installments', placeholder: 'Parcelas' },
Â  Â  Â  Â  },
Â  Â  Â  Â  callbacks: {
Â  Â  Â  Â  Â  onFormMounted: error => { if (error) console.warn('CardForm mount error:', error); },
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }catch(e){ console.error('Falha ao iniciar MP:', e); }

Â  Â  wirePayTips = setTips; // expÃµe p/ outras funÃ§Ãµes
Â  }

Â  function togglePayPanel(show){
Â  Â  const p = document.getElementById('payPanel');
Â  Â  if (!p) return;
Â  Â  p.style.display = show ? 'block' : 'none';
Â  Â  if (show) {
Â  Â  Â  updatePayPanelTotal();
Â  Â  Â  p.scrollIntoView({ behavior: 'smooth', block: 'center' });
Â  Â  }
Â  Â  if (!show) document.getElementById('payResult').innerHTML = '';
Â  }

Â  function updatePayPanelTotal(){
Â  Â  const t = computeTotal();
Â  Â  const elT = document.getElementById('payPanelTotal');
Â  Â  if (elT) elT.textContent = fmtBRL(t);

Â  Â  // mantÃ©m amount atualizado no CardForm
Â  Â  if (cardForm) {
Â  Â  Â  try { cardForm.update({ amount: String(t.toFixed ? t.toFixed(2) : t) }); } catch{}
Â  Â  }
Â  }

Â  function getChosenMethod(){
Â  Â  const r = document.querySelector('input[name="paymethod"]:checked');
Â  Â  return r ? r.value : 'pix';
Â  }

Â  // serÃ¡ sobrescrita em ensurePayPanel
Â  let wirePayTips = ()=>{};

Â  async function doProcessPayment(){
Â  Â  const orderId = CURRENT_ORDER_ID || makeOrderId();
Â  Â  const productKey = cur;
Â  Â  const method = getChosenMethod();

Â  Â  // flags dos bumps
Â  Â  const bumps = Array.from(el('bumps').querySelectorAll('input[type=checkbox]'));
Â  Â  const flags = {}; bumps.forEach(chk => { flags[chk.dataset.id] = !!chk.checked; });

Â  Â  const out = document.getElementById('payResult');
Â  Â  out.innerHTML = 'Processandoâ€¦';

Â  Â  // ===== PIX (jÃ¡ funcionava) =====
Â  Â  if (method === 'pix') {
Â  Â  Â  try {
Â  Â  Â  Â  const r = await fetch('/mp/process-payment', {
Â  Â  Â  Â  Â  method:'POST',
Â  Â  Â  Â  Â  headers:{'Content-Type':'application/json'},
Â  Â  Â  Â  Â  body: JSON.stringify({ orderId, productKey, method, bumps: flags })
Â  Â  Â  Â  });
Â  Â  Â  Â  const j = await r.json();

Â  Â  Â  Â  if (!j?.ok) {
Â  Â  Â  Â  Â  out.innerHTML = `<span style="color:#f87171">Falha: ${j?.error || 'erro desconhecido'}</span>`;
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  if (j.method === 'pix' && j.pix) {
Â  Â  Â  Â  Â  const { qr_base64, copia_e_cola } = j.pix;
Â  Â  Â  Â  Â  out.innerHTML = `
Â  Â  Â  Â  Â  Â  <div class="qr-wrap">
Â  Â  Â  Â  Â  Â  Â  ${qr_base64 ? `<div class="qr"><img src="data:image/png;base64,${qr_base64}" alt="QR Pix"></div>` : ''}
Â  Â  Â  Â  Â  Â  Â  <div class="pix-side">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="muted" style="margin-bottom:6px">CÃ³digo copia-e-cola:</div>
Â  Â  Â  Â  Â  Â  Â  Â  <pre class="codebox" id="pixCode">${copia_e_cola || ''}</pre>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="copyPix" style="margin-top:6px;padding:8px 12px;border:0;border-radius:8px;background:#22c55e;color:#062a12;cursor:pointer;font-weight:600;">Copiar cÃ³digo</button>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  const b = document.getElementById('copyPix');
Â  Â  Â  Â  Â  if (b) b.onclick = async ()=>{
Â  Â  Â  Â  Â  Â  try { await navigator.clipboard.writeText(copia_e_cola || ''); b.textContent='Copiado!'; setTimeout(()=>b.textContent='Copiar cÃ³digo', 1500); } catch{}
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  out.innerHTML = 'Pagamento criado.';
Â  Â  Â  Â  }
Â  Â  Â  } catch(e){
Â  Â  Â  Â  out.innerHTML = `<span style="color:#f87171">Erro de rede: ${e.message}</span>`;
Â  Â  Â  }
Â  Â  Â  return;
Â  Â  }

Â  Â  // ===== CARTÃƒO (on-site) =====
Â  Â  if (method === 'card') {
Â  Â  Â  try{
Â  Â  Â  Â  // garante amount correto
Â  Â  Â  Â  updatePayPanelTotal();

Â  Â  Â  Â  if (!cardForm) {
Â  Â  Â  Â  Â  out.innerHTML = `<span style="color:#f87171">Falha ao iniciar o formulÃ¡rio do cartÃ£o.</span>`;
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  const data = cardForm.getCardFormData(); // pega token + campos
Â  Â  Â  Â  const email = (document.getElementById('form-payer-email')?.value || '').trim();
Â  Â  Â  Â  const docNumber = (document.getElementById('form-doc-number')?.value || '').replace(/\D+/g,'');
Â  Â  Â  Â  if (!data?.token) {
Â  Â  Â  Â  Â  out.innerHTML = `<span style="color:#f87171">NÃ£o foi possÃ­vel tokenizar o cartÃ£o. Verifique os dados.</span>`;
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  orderId, productKey, method,
Â  Â  Â  Â  Â  bumps: flags,
Â  Â  Â  Â  Â  card: {
Â  Â  Â  Â  Â  Â  token: data.token,
Â  Â  Â  Â  Â  Â  installments: Number(data.installments) || 1,
Â  Â  Â  Â  Â  Â  issuer_id: data.issuerId || data.issuer || null,
Â  Â  Â  Â  Â  Â  payment_method_id: data.paymentMethodId || data.payment_method_id || null,
Â  Â  Â  Â  Â  Â  payer: {
Â  Â  Â  Â  Â  Â  Â  email,
Â  Â  Â  Â  Â  Â  Â  identification: { type: 'CPF', number: docNumber }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  const r = await fetch('/mp/process-payment', {
Â  Â  Â  Â  Â  method:'POST',
Â  Â  Â  Â  Â  headers:{'Content-Type':'application/json'},
Â  Â  Â  Â  Â  body: JSON.stringify(payload)
Â  Â  Â  Â  });
Â  Â  Â  Â  const j = await r.json();

Â  Â  Â  Â  if (!j?.ok) {
Â  Â  Â  Â  Â  out.innerHTML = `<span style="color:#f87171">Falha: ${j?.error || 'erro desconhecido'}</span>`;
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Mostra status
Â  Â  Â  Â  const status = (j.status || j.payment?.status || '').toUpperCase();
Â  Â  Â  Â  const detail = j.payment?.status_detail || j.status_detail || '';
Â  Â  Â  Â  const txt =
Â  Â  Â  Â  Â  status === 'APPROVED' ? 'Pagamento aprovado ðŸŽ‰' :
Â  Â  Â  Â  Â  status === 'IN_PROCESS' || status === 'PENDING' ? 'Pagamento em anÃ¡lise/pendente' :
Â  Â  Â  Â  Â  status ? `Status: ${status}` : 'Pagamento criado.';

Â  Â  Â  Â  document.getElementById('card-result').innerHTML =
Â  Â  Â  Â  Â  `<div class="ok" style="color:#cfe7d7">${txt}${detail ? ` â€” ${detail}` : ''}</div>`;
Â  Â  Â  Â  out.innerHTML = '';
Â  Â  Â  }catch(e){
Â  Â  Â  Â  out.innerHTML = `<span style="color:#f87171">Erro: ${e.message}</span>`;
Â  Â  Â  }
Â  Â  Â  return;
Â  Â  }

Â  Â  // ===== BOLETO (on-site) =====
Â  Â  if (method === 'boleto') {
Â  Â  Â  try{
Â  Â  Â  Â  const name = (document.getElementById('boleto-name')?.value || '').trim();
Â  Â  Â  Â  const cpf Â = (document.getElementById('boleto-cpf')?.value || '').replace(/\D+/g,'');
Â  Â  Â  Â  const email= (document.getElementById('boleto-email')?.value || '').trim();

Â  Â  Â  Â  if (!name || !cpf || !email){
Â  Â  Â  Â  Â  out.innerHTML = `<span style="color:#f87171">Preencha nome, CPF e e-mail para gerar o boleto.</span>`;
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const r = await fetch('/mp/process-payment', {
Â  Â  Â  Â  Â  method:'POST',
Â  Â  Â  Â  Â  headers:{'Content-Type':'application/json'},
Â  Â  Â  Â  Â  body: JSON.stringify({
Â  Â  Â  Â  Â  Â  orderId, productKey, method, bumps: flags,
Â  Â  Â  Â  Â  Â  boleto: { name, cpf, email }
Â  Â  Â  Â  Â  })
Â  Â  Â  Â  });
Â  Â  Â  Â  const j = await r.json();

Â  Â  Â  Â  if (!j?.ok) {
Â  Â  Â  Â  Â  out.innerHTML = `<span style="color:#f87171">Falha: ${j?.error || 'erro desconhecido'}</span>`;
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const br = document.getElementById('boleto-result');
Â  Â  Â  Â  const link = j.boleto?.ticket_url || j.payment?.transaction_details?.external_resource_url || '';
Â  Â  Â  Â  const barcode = j.boleto?.barcode || j.payment?.barcode || j.payment?.barcode_content || '';

Â  Â  Â  Â  br.innerHTML = `
Â  Â  Â  Â  Â  <div class="ok" style="color:#cfe7d7">Boleto gerado com sucesso.</div>
Â  Â  Â  Â  Â  ${link ? `<div style="margin-top:6px"><a href="${link}" target="_blank" rel="noopener" style="color:#93c5fd">Abrir boleto em nova aba</a></div>` : ''}
Â  Â  Â  Â  Â  ${barcode ? `<div class="muted" style="margin-top:8px">Linha digitÃ¡vel:</div><pre class="codebox">${barcode}</pre>` : ''}
Â  Â  Â  Â  `;
Â  Â  Â  Â  out.innerHTML = '';
Â  Â  Â  }catch(e){
Â  Â  Â  Â  out.innerHTML = `<span style="color:#f87171">Erro: ${e.message}</span>`;
Â  Â  Â  }
Â  Â  Â  return;
Â  Â  }
Â  }

Â  function buildRedirectUrl(orderId){
Â  Â  let url = `/mp/checkout?product=${cur}&orderId=${orderId}`;
Â  Â  const bumps = Array.from(el('bumps').querySelectorAll('input[type=checkbox]'));
Â  Â  const params = new URLSearchParams();
Â  Â  bumps.forEach(chk => params.set(chk.dataset.id, chk.checked ? '1' : '0'));
Â  Â  const glue = url.includes('?') ? '&' : '?';
Â  Â  url = url + glue + params.toString();
Â  Â  return url;
Â  }

Â  function onBuy(){
Â  Â  const orderId = makeOrderId();
Â  Â  CURRENT_ORDER_ID = orderId;

Â  Â  try {
Â  Â  Â  const payload = { orderId, productKey: cur };
Â  Â  Â  if (navigator.sendBeacon) {
Â  Â  Â  Â  navigator.sendBeacon('/analytics/checkout-click', new Blob([JSON.stringify(payload)], { type:'application/json' }));
Â  Â  Â  } else {
Â  Â  Â  Â  fetch('/analytics/checkout-click', {
Â  Â  Â  Â  Â  method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload), keepalive: true
Â  Â  Â  Â  }).catch(()=>{});
Â  Â  Â  }
Â  Â  } catch(e){}

Â  Â  togglePayPanel(true);
Â  }

Â  loadConfig().catch(err=>{ console.error(err); alert('Falha ao carregar configuraÃ§Ãµes.'); });
Â  </script>

</body>
</html>